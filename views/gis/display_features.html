{{include 'jquery.html'}}
{{include 'ext.html'}}

{{include 'gis/ol_js_loaders.html'}}

<script type="text/javascript">//<![CDATA[

{{include 'gis/ol_start_vars.js'}}

{{include 'gis/ol_layers_all.js'}}

{{include 'gis/ol_vector_registerEvents.js'}}

{{include 'gis/ol_controls_features.js'}}

{{include 'gis/ol_functions.js'}}

    map = new OpenLayers.Map('center', options);
	
    addLayers(map);
    
    var strategy = new OpenLayers.Strategy.Cluster({distance: {{=cluster_distance}}, threshold: {{=cluster_threshold}}});
    {{include 'gis/ol_layers_features.js'}}
    
	{{include 'gis/ol_controls.js'}}
    
  {{if zoom:}}
    var zoom = {{=zoom}};
  {{else:}}
    // This fails to give the correct zoom, hence we map.zoomToExtent() later
    var zoom = map.getZoomForExtent(bounds);
  {{pass}}
    
    var mapPanel = new GeoExt.MapPanel({
        region: "center",
        id: "mappanel",
        xtype: "gx_mappanel",
        map: map,
        center: center,
        zoom: zoom,
        tbar: new Ext.Toolbar()
    });
    
    {{include 'gis/toolbar.js'}}
    
    var layerTreeBase = new GeoExt.tree.BaseLayerContainer({
        text: "{{=T('Base Layers')}}",
        layerStore: mapPanel.layers,
        leaf: false,
        expanded: true
    });

    var layerTreeFeaturesExternal = new GeoExt.tree.OverlayLayerContainer({
        text: "{{=T('External Features')}}",
        layerStore: mapPanel.layers,
        leaf: false,
        expanded: true
    });

    var layerTreeFeaturesInternal = new GeoExt.tree.OverlayLayerContainer({
        text: "{{=T('Internal Features')}}",
        layerStore: mapPanel.layers,
        leaf: false,
        expanded: true
    });

    var layerTree = new Ext.tree.TreePanel({
        id: "treepanel",
        title: "{{=T("Layers")}}",
        root: new Ext.tree.AsyncTreeNode({
            expanded: true,
            children: [layerTreeBase]
        }),
        rootVisible: false,
        split: true,
        collapsible: true,
        collapseMode: "mini",
        autoScroll: true,
        lines: false,
        enableDD: true
    });
    
    var win = new Ext.Window({
		//title    : 'Sahana Map Viewing Client',
		collapsible: true,
		maximizable: true,
		titleCollapse: true,
		width: {{=width}},
		height: {{=height}},
		layout: 'border',
		items:  [{
                    region: "west",
                    id: "tools",
                    title: "{{=T("Tools")}}",
                    border: true,
                    width: 250,
                    collapsible: true,
                    split: true,
                    items: [ layerTree ]
                },
                mapPanel
                ]
    });

// This is outside Ext.OnReady() so that it is called from a DIV imported via innerHTML
win.show();

{{if zoom:}}
{{else:}}
  map.zoomToExtent(bounds);
{{pass}}
    
Ext.onReady(function() {

	//win.show();
    Ext.QuickTips.init();
    
});

//]]></script>

{{include 'gis/ol_status.html'}}
