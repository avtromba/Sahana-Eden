<!-- File to be included in a form which needs to be able to add a new feature to the database via map entry -->

<div class='message information'>
You can move around and enlarge/reduce the size of the area you want using the scale on upper left corner of the map.<br>
By clicking on the map you can mark your location with a pointer..
</div>
 
<div id="outer_map" style="width: 600px; height: 800px; background-color: #FFFFFF"> 
 <div id='gis_map_toolbar' >
  <fieldset id='gis_map_toolbar_fieldset' style="border: 1px solid ; padding: 5px; padding-bottom:2px;">
   <div id="gis_map_toolbar_default">
    <span title="Expand Map"><a onclick="shn_gis_map_expand()" alt="Full screen map"><div id="gis_map_icon_expand" style="width: 24px; height: 22px;"></div></a></span>
   </div>
   <div id="gis_map_toolbar_manipulate">
    <span title="Navigate"><a onclick="shn_gis_map_control_navigate()" alt="Navigate"><div id="gis_map_icon_select" style="width: 24px; height: 22px;"></div></a></span>
    <span title="Add Point"><a onclick="shn_gis_map_control_add_point()" alt="Add Point"><div id="gis_map_icon_addpoint" style="width: 24px; height: 22px;"></div></a></span>
    <span title="Add Line"><a onclick="shn_gis_map_control_add_line()" alt="Add Line"><div id="gis_map_icon_addline" style="width: 24px; height: 22px;"></div></a></span>
    <span title="Add Area"><a onclick="shn_gis_map_control_add_polygon()" alt="Add Area"><div id="gis_map_icon_addpolygon" style="width: 24px; height: 22px;"></div></a></span>
    <span title="Toggle Freehand Draw"><a onclick="shn_gis_map_control_freehand()" alt="Toggle Freehand Draw"><div id="gis_map_icon_freehand" style="width: 24px; height: 22px;"></div></a></span>
    <span title="Mode Description" id="gis_map_icon_descripion"></span>
   </div>
  </fieldset>
 </div>
 <div style="float: left; width: 100%;">
 </div>
 <div id="map" style="border: 2px solid black;  background-color: #FFFFFF">
 </div> 
</div>
    
<script type="text/javascript">
    
    // make map available for easy debugging
    var map;
    
    // make features available
    var featuresLayer, currentFeature;

    // Make Controls Available
    var selectControl;
    var dragControl;
    //var modifyControl;
    var pointControl;
    var lineControl;
    var polygonControl;
    
    // avoid pink tiles
    OpenLayers.IMAGE_RELOAD_ATTEMPTS = 3;
    OpenLayers.Util.onImageLoadErrorColor = "transparent";

    // Set Proxy Host
    OpenLayers.ProxyHost = '/sahana/static/proxy.py?url=';

    var lon = 79.4;
    var lat = 6;
    var zoom = 7;

    // See - http://crschmidt.net/~crschmidt/spherical_mercator.html#reprojecting-points
    var proj4326 = new OpenLayers.Projection("EPSG:4326");
    var projection_current = new OpenLayers.Projection('EPSG:900913');
    var point = new OpenLayers.LonLat(lon, lat);

    // Map Options
    var options = {
        displayProjection: proj4326,
        projection: projection_current,
        units: "m",
                    maxResolution: 156543.0339,
                        maxExtent: new OpenLayers.Bounds(-20037508, -20037508, 20037508, 20037508.34),
                        //restrictedExtent: new OpenLayers.Bounds()
                };

    // Start Map
    function initMap()
    {
    map = new OpenLayers.Map('map', options);
var mapnik = new OpenLayers.Layer.TMS( "OpenStreetMap (Mapnik)", "http://tile.openstreetmap.org/", {type: 'png', getURL: osm_getTileURL, displayOutsideMaxExtent: true } );
map.addLayer(mapnik);
var wmslayer1 = new OpenLayers.Layer.WMS( "VMap0",
"http://labs.metacarta.com/wms/vmap0",
{layers:'basic', isBaseLayer:'true', wrapDateLine:'true'});
map.addLayer(wmslayer1);
featuresLayer = new OpenLayers.Layer.Vector("Feature");map.addLayer(featuresLayer);
    map.addControl(new OpenLayers.Control.LayerSwitcher());
    map.addControl(new OpenLayers.Control.PanZoomBar());
    map.addControl(new OpenLayers.Control.ScaleLine());
    map.addControl(new OpenLayers.Control.MousePosition());
    map.addControl(new OpenLayers.Control.OverviewMap({mapOptions: options}));
   
    // Add control to add new Points to the map.
    pointControl = new OpenLayers.Control.DrawFeature(featuresLayer, OpenLayers.Handler.Point);
    pointControl.featureAdded = shn_gis_map_add_geometry;
    map.addControl(pointControl);
    // Add control to add new Lines to the map.
    lineControl = new OpenLayers.Control.DrawFeature(featuresLayer, OpenLayers.Handler.Path);
    lineControl.featureAdded = shn_gis_map_add_geometry;
    map.addControl(lineControl);
    // Add control to add new Polygons to the map.
    polygonControl = new OpenLayers.Control.DrawFeature(featuresLayer, OpenLayers.Handler.Polygon);
    polygonControl.featureAdded = shn_gis_map_add_geometry;
    map.addControl(polygonControl);
shn_gis_map_control_navigate();    // Center the map.
    map.setCenter(point.transform(proj4326, map.getProjectionObject()), zoom);
    }
    window.onload(initMap());
    function shn_gis_map_add_geometry(feature){
    
        var fcopy = feature.clone();
        // need for later.
        var fcopygeom = fcopy.geometry.clone();
        var lonlat = fcopy.geometry.getBounds().getCenterLonLat();
        var proj_current = map.getProjectionObject();
        lonlat.transform(proj_current, proj4326);
        var lon_new = lonlat.lon;
        var lat_new = lonlat.lat;
        var wkt_new = fcopy.geometry.transform(proj_current, proj4326).toString();
        var type_new = featureTypeStr(fcopy);
        
        // Update form fields
        var x_gps = document.getElementById("gps_x");
        var y_gps = document.getElementById("gps_y");
        if( x_gps != null && y_gps != null){
            x_gps.value = lon_new;
            y_gps.value = lat_new;
        }

        // store x,y coords in hidden variables named loc_x, loc_y
        // must be set via calling page
        var x_point = document.getElementsByName("loc_x");
        var y_point = document.getElementsByName("loc_y");
        if(x_point != null && y_point != null){
            x_point[0].value = lon_new;
            y_point[0].value = lat_new;
        }
        // store type
        var loc_type = document.getElementsByName("loc_type");
        if(loc_type != null){
            loc_type[0].value = type_new;
        }
        // store wkt value
        var wkt_point = document.getElementsByName("loc_wkt");
        if(wkt_point != null){
            wkt_point[0].value = wkt_new;
        }
        
        // Remove last plot from layer
        featuresLayer.destroyFeatures(featuresLayer.features);
        
        // Add icon.  
        add_Feature(featuresLayer, 'newFeature', fcopygeom, '/sahana/static/img/marker.png');
    }
    // Add marker to map
    function add_Feature(layer, feature_id, geom, iconURL){
        // Set icon dims
        var icon_img = new Image();
        icon_img.src = iconURL;
        var max_w = 25;
        var max_h = 35;
        var width = icon_img.width;
        var height = icon_img.height;
        if(width > max_w){
            height = ((max_w / width) * height);
            width = max_w;
        }
        if(height > max_h){
            width = ((max_h / height) * width);
            height = max_h;
        }
        // http://www.nabble.com/Markers-vs-Features--td16497389.html
        var style_marker = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
        //style_mark.pointRadius = 12;
        style_marker.graphicWidth = width;
        style_marker.graphicHeight = height;
        style_marker.graphicXOffset = -(width / 2);
        style_marker.graphicYOffset = -height;
        style_marker.externalGraphic = iconURL;
        style_marker.graphicOpacity = 1;
        // Create Feature Vector + Props
        var featureVec = new OpenLayers.Feature.Vector(geom, null, style_marker);
        featureVec.fid = feature_id;
        // Add Feature.
        layer.addFeatures([featureVec]);
    }
    // General functions usable by all Layers
    
    // returns string type of a feature
    // return point if not line or poly ....danger....
    function featureTypeStr(feature){
        var type = 'point';
        var geotype = feature.geometry.CLASS_NAME;
        if(geotype == 'OpenLayers.Geometry.LineString'){
            type = 'line';
        } else if(geotype == 'OpenLayers.Geometry.Polygon'){
            type = 'poly';
        }
        return type;
    }
    // create geometries from point coords.
    function coordToGeom(coords, type){
        var geom = coords[0]
        if(type == 'point'){
            geom = coords[0]; // =  Array(new OpenLayers.Geometry.Point(lon, lat));
        } else if(type == 'line'){
            geom = new OpenLayers.Geometry.LineString(coords);
        } else if(type == 'poly'){
            geom = new OpenLayers.Geometry.Polygon(new Array(new OpenLayers.Geometry.LinearRing(coords)));
        } 
        return geom;
    }
    // Report Errors to a DIV
    function ReportErrors(div,text) {
         $(div).innerHTML = text;
    }
    // For KML layers
    function onFeatureUnselect(feature) {
        map.removePopup(feature.popup);
        feature.popup.destroy();
        feature.popup = null;
    }
    // For OSM File layers
    function on_feature_hover(feature) {
            var text ="<ul>";
            var type ="way";
            if (feature.geometry.CLASS_NAME == "OpenLayers.Geometry.Point") {
                type = "node";
            }    
            text += "<li>" + feature.osm_id + ": <a href='http://www.openstreetmap.org/api/0.5/"+type + "/" + feature.osm_id + "'>API</a></li>";
            for (var key in feature.attributes) {
                text += "<li>" + key + ": " + feature.attributes[key] + "</li>";
            }
            text += "</ul>";
            $("status_osm").innerHTML = text;
    }
            function osm_getTileURL(bounds) {
            var res = this.map.getResolution();
            var x = Math.round((bounds.left - this.maxExtent.left) / (res * this.tileSize.w));
            var y = Math.round((this.maxExtent.top - bounds.top) / (res * this.tileSize.h));
            var z = this.map.getZoom();
            var limit = Math.pow(2, z);
            if (y < 0 || y >= limit) {
                return OpenLayers.Util.getImagesLocation() + "404.png";
            } else {
                x = ((x % limit) + limit) % limit;
                return this.url + z + "/" + x + "/" + y + "." + this.type;
            }
        }
       // Activate Control for navigating around the maps.
   function shn_gis_map_control_navigate(){
        shn_gis_map_control_deactivate_all();
        document.getElementById('gis_map_icon_select').style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/move_feature_on.png)";
        document.getElementById('gis_map_icon_descripion').innerHTML = 'Mode: Navigate';
    }
    // Activate Control for selecting features.
    function shn_gis_map_control_select(){
        shn_gis_map_control_deactivate_all();
        document.getElementById('gis_map_icon_select').style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/move_feature_on.png)";
        document.getElementById('gis_map_icon_descripion').innerHTML = 'Mode: Select';
        selectControl.activate();
    }
    // Activate Control for dragging features.
    function shn_gis_map_control_drag(){
        shn_gis_map_control_deactivate_all();
        document.getElementById('gis_map_icon_drag').style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/pan_on.png)";
        document.getElementById('gis_map_icon_descripion').innerHTML = 'Mode: Drag';
        dragControl.activate();
    }
    // Activate Control for modifying features.
    function shn_gis_map_control_modify(){
        shn_gis_map_control_deactivate_all();
        //document.getElementById('gis_map_icon_modify').style.backgroundImage = "url()";
        //document.getElementById('gis_map_icon_descripion').innerHTML = 'Mode: Modify';
        //modifyControl.activate();
    }
    // Activate Control for adding point features.
    function shn_gis_map_control_add_point(){
        shn_gis_map_control_deactivate_all();
        document.getElementById('gis_map_icon_addpoint').style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/draw_point_on.png)";
        document.getElementById('gis_map_icon_descripion').innerHTML = 'Mode: Add Point';
        pointControl.activate();
    }
    // Activate Control for adding line features.
    function shn_gis_map_control_add_line(){
        shn_gis_map_control_deactivate_all();
        document.getElementById('gis_map_icon_addline').style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/draw_line_on.png)";
        document.getElementById('gis_map_icon_descripion').innerHTML = 'Mode: Add line';
        lineControl.activate();
    }
    // Activate Control for adding polygon features.
    function shn_gis_map_control_add_polygon(){
        shn_gis_map_control_deactivate_all();
        document.getElementById('gis_map_icon_addpolygon').style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/draw_polygon_on.png)";
        document.getElementById('gis_map_icon_descripion').innerHTML = 'Mode: Add Area';
        polygonControl.activate();
    }
    // Activate Control for drawing features freehand.
    function shn_gis_map_control_freehand(){
        if(lineControl.handler.freehand){
            document.getElementById('gis_map_icon_freehand').style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/freehand_off.png)";
            document.getElementById('gis_map_icon_descripion').innerHTML = 'Mode: Freehand OFF';
            lineControl.handler.freehand = false;
            polygonControl.handler.freehand = false;
        } else{
            document.getElementById('gis_map_icon_freehand').style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/freehand_on.png)";
            document.getElementById('gis_map_icon_descripion').innerHTML = 'Mode: Freehand ON';
            lineControl.handler.freehand = true;
            polygonControl.handler.freehand = true;
        }
    }
    // Deactivate all other controls
    function shn_gis_map_control_deactivate_all(){
        // Turn off navigate
        var nav = document.getElementById('gis_map_icon_select')
        if(nav != null){
            nav.style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/move_feature_off.png)";
        }
        // Turn off select
        if(selectControl != null){
            selectControl.unselectAll();
            selectControl.deactivate();
            document.getElementById('gis_map_icon_select').style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/move_feature_off.png)";
        }
        // Turn off drag
        if(dragControl != null){
            dragControl.deactivate();
            document.getElementById('gis_map_icon_drag').style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/pan_off.png)";
        }
        // Turn off modify
        //if(modifyControl != null){
        //modifyControl.deactivate();
        //}
        // Drop features/popups in progress from a create feature.
        if(currentFeature != null && ((pointControl != null && pointControl.active) || (lineControl != null && lineControl.active) || (polygonControl != null && polygonControl.active))){
            if(currentFeature.popup != null){
                currentFeature.popup.hide();
                currentFeature.popup.destroy(currentFeature.popup);
            }
            featuresLayer.removeFeatures([currentFeature]);
            currentFeature.destroy();
            currentFeature = null;
        }
        // Hide any popup showing and deactivate current feature.
        if(currentFeature != null){
            if(currentFeature.popup != null){
                currentFeature.popup.hide();
            }
            currentFeature = null;
        }
        // Turn off point add
        if(pointControl != null){
            pointControl.deactivate();
            document.getElementById('gis_map_icon_addpoint').style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/draw_point_off.png)";
        }
        // Turn off line add
        if(lineControl != null){
            lineControl.deactivate();
            document.getElementById('gis_map_icon_addline').style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/draw_line_off.png)";
        }
        // Turn off polygon add
        if(polygonControl != null){
            polygonControl.deactivate();
            document.getElementById('gis_map_icon_addpolygon').style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/draw_polygon_off.png)";
        }
    }
    function shn_gis_map_expand()
    {
        var omap = document.getElementById("outer_map");
        var amap = document.getElementById("map");
        var tmap = document.getElementById("gis_map_toolbar");
        var fmap = document.getElementById("gis_map_toolbar_fieldset");
        var expd = document.getElementById("gis_map_icon_expand");
        // If currently small, make big
        if(omap.style.position != 'fixed'){
            expd.style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/map_resize_in_c.png)";
            amap.style.width = '100%';
            amap.style.height = '100%';
            omap.style.position = 'fixed';
            omap.style.top = '0px';
            omap.style.left = '0px';
            omap.style.width = '100%';
            omap.style.height = '100%';
            omap.style.marginLeft = '0px';
            fmap.style.border = '0px none';
            tmap.style.margin = '0px';
        }
        // If currently big, make small
        else {
            expd.style.backgroundImage = "url(/sahana/static/mfbase/openlayers/theme/default/img/map_resize_out_c.png)";
            amap.style.width = '760px';
            amap.style.height = '600px';
            omap.style.position = 'relative';
            omap.style.top = 'auto';
            omap.style.left = 'auto';
            omap.style.width = 'auto';
            omap.style.height = 'auto';
            omap.style.marginLeft = '10px';
            fmap.style.border = '1px solid';
            tmap.style.margin = '10px 10px 10px 0px';
        }
    }
    // On Creating a new feature Display a popup box to enter details.
    function shn_gis_map_create_feature(feature){
        // If adding a new popup before an old one is completed, kill old popup (current feature is set to null at end of process)
        if(currentFeature != null){
            currentFeature.popup.hide();
            featuresLayer.removeFeatures([currentFeature]);
            currentFeature.popup.destroy(currentFeature.popup);
            currentFeature.destroy();
        }
        // Generate Popup + Props
        var fc_id = null;
        var fc_lonlat = feature.geometry.getBounds().getCenterLonLat();
        var fc_size = null;
        var fc_contentHTML = "<div class='gis_openlayers_popupbox' id='popup_'><form method='post' action='index.php?mod=admin&amp;act=gis_database_classes_edit' id='form0' name='form0'><input name='seq' value='seq_3' type='hidden' />   <div class='gis_openlayers_popupbox_header'>     <div class='gis_openlayers_popupbox_header_r'>       <div class='gis_openlayers_popupbox_author'><label for='gis_popup_author' >Author:</label> <input type='text' name='gis_popup_author' id='popup__popup_auth' size='15' maxlength='60' tabindex=8 /></div>       <div class='gis_openlayers_popupbox_date'><label for='gis_popup_date' >Date:</label> <input type='text' name='gis_popup_date' id='popup__popup_edate' size='15' tabindex=9 /></div>     </div>     <div class='gis_openlayers_popupbox_header_l'>       <div class='gis_openlayers_popupbox_name'><label for='gis_popup_name'>Name:</label> <span><input type='text' name='gis_popup_name' id='popup__popup_name' size='10' maxlength='60' tabindex=6 /></span> ()</div>       <div class='gis_openlayers_popupbox_url'><label for='gis_popup_name'>Url:</label> <input type='text' name='gis_popup_url' id='popup__popup_url' size='40' maxlength='100' tabindex=7 /></div>     </div>      <div class='gis_openlayers_popupbox_address'><b>Address:</b> <input type='text' name='gis_popup_address' id='popup__popup_add' size='55' maxlength='200' tabindex=10 /></div>   </div>   <div class='gis_openlayers_popupbox_body'>     <span class='gis_openlayers_popupbox_text'><textarea rows='5' cols='70' name='gis_popup_desc' id='popup__popup_desc' tabindex=11 ></textarea></span>  </div>  <div class='gis_openlayers_popupbox_footer'>      <span><a onclick='shn_gis_popup_new_cancel(&#39popup_&#39)' alt='cancel'><div class='gis_openlayers_popupbox_edit_cancel' style='width: 17px; height: 17px;'></div><span>cancel</span></a></span>      <span><a onclick='shn_gis_popup_new_ok(&#39popup_&#39)' alt='ok'><div class='gis_openlayers_popupbox_edit_ok' style='width: 17px; height: 17px;'></div><span>ok</span></a></span>   </div>  <div style='clear: both;'></div></form></div>";
        var fc_anchor = null;
        var fc_closeBox = true; // Bad can close without create...
        var fc_closeBoxCallback = shn_gis_popup_new_cancel;
        var framedCloud = new OpenLayers.Popup.FramedCloud(fc_id, fc_lonlat, fc_size, fc_contentHTML, fc_anchor, fc_closeBox, fc_closeBoxCallback);
        framedCloud.autoSize = true;
        framedCloud.minSize = new OpenLayers.Size(460,270);
        // Add Popup
        feature.popup = framedCloud;
        map.addPopup(feature.popup);
        feature.popup.show();
        currentFeature = feature;
    }
    // Supports feature select control.
    function onFeatureSelect_1(feature){
        // Set global for back referencing
        currentFeature = feature;
        if (feature.popup.map == null) {
            map.addPopup(feature.popup);
            feature.popup.show();
        } else {
            feature.popup.toggle();
        }
    }
    // Supports feature select control.
    function onFeatureUnselect_1(feature) {
        feature.popup.hide();
    }
    // Supports feature select control.
    function onPopupClose(evt) {
        onFeatureUnselect_1(currentFeature);
    }
    var xmlHttp
    function shn_gis_popup_unable()
    {
        alert ("The module that created this feature does not support this action here. Navigate to the module manually to perform this action.");
    }
    function shn_gis_popup_print()
    {
        if (xmlHttp.readyState == 4){
            var textDoc = xmlHttp.responseText;
            currentFeature.popup.setContentHTML(textDoc);
        }
    }
    function shn_gis_popup_refresh_print()
    {
        if (xmlHttp.readyState == 4){
            var textDoc = xmlHttp.responseText;
            if(textDoc == '<delete />'){
                currentFeature.popup.hide();
                featuresLayer.removeFeatures([currentFeature]);
                currentFeature.popup.destroy(currentFeature.popup);
                currentFeature.destroy();
                //featuresLayer.redraw();
            } else{
                currentFeature.popup.setContentHTML(textDoc);
            }
        }
    }
    function shn_gis_popup_new_print()
    {
        if (xmlHttp.readyState == 4){
            var textDoc = xmlHttp.responseText;
            
            var geom = currentFeature.geometry.clone();
                  
            currentFeature.popup.hide();
            featuresLayer.removeFeatures([currentFeature]);
            currentFeature.popup.destroy(currentFeature.popup);
            currentFeature.destroy();
            currentFeature = null;
            //featuresLayer.redraw();
            if(!(textDoc == 'fail' || textDoc == '')){ 
                var uuidpos = textDoc.search('<uuid />');
                var iconURLPos = textDoc.search('<icon />');
                
                var uuid = textDoc.substring(0, uuidpos);
                var iconURL = textDoc.substring((uuidpos + 8), iconURLPos);
                var html = textDoc.substring((iconURLPos + 8));

                add_Feature_with_popup(featuresLayer, uuid, geom, html, iconURL);
            } else{
                alert("Failed to create new Feature.");   
            }
        }
    }
    // Called by link in popup box
    function shn_gis_popup_new_ok(id){
        xmlHttp = GetXmlHttpObject();
        if (xmlHttp==null){
            alert ("Your browser does not support AJAX!");
            return;
        }
        // Clone to stop any effects on the current feature.
        var cfcopy = currentFeature.clone();
        // returns string type of a feature
        // return point if not line or poly ....danger....
        var type = featureTypeStr(cfcopy);
        // Transform for db.
        var lonlat = cfcopy.geometry.getBounds().getCenterLonLat().clone();
        var proj_current = map.getProjectionObject();
        lonlat.transform(proj_current, proj4326);
        var lat = lonlat.lat;
        var lon = lonlat.lon;
        var wkt = cfcopy.geometry.transform(proj_current, proj4326).toString();
        var name  = document.getElementById(id + '_popup_name').value;
        var desc  = document.getElementById(id + '_popup_desc').value;
        var auth  = document.getElementById(id + '_popup_auth').value;
        var furl  = document.getElementById(id + '_popup_url').value;
        var add   = document.getElementById(id + '_popup_add').value;
        var edate = document.getElementById(id + '_popup_edate').value;
        // Send to db
        var url = 'index.php?act=gis_popup_new_ok&mod=xst&stream=text';
        url = url + "&type=" + type + "&center_lat=" + lat + "&center_lon=" + lon + "&wkt=" + wkt + "&name=" + name + "&desc=" + desc + "&auth=" + auth + "&url=" + furl + "&add=" + add + "&date=" + edate;
        url = url + "&sid=" + Math.random();
        xmlHttp.onreadystatechange = shn_gis_popup_new_print;
        xmlHttp.open("GET", url, true);
        xmlHttp.send(null);
    }
    // Called by link in popup box
    function shn_gis_popup_new_cancel(){
        currentFeature.popup.hide();
        featuresLayer.removeFeatures([currentFeature]);
        currentFeature.popup.destroy(currentFeature.popup);
        currentFeature.destroy();
        currentFeature = null;
    }
    // Called by link in popup box
    function shn_gis_popup_refresh(id)
    {
        xmlHttp = GetXmlHttpObject();
        if (xmlHttp == null){
            alert ("Your browser does not support AJAX!");
            return;
        }

        var url = 'index.php?act=gis_popup_refresh&mod=xst&stream=text&id=' + id;
        url = url +"&sid=" + Math.random();
        xmlHttp.onreadystatechange = shn_gis_popup_refresh_print;
        xmlHttp.open("GET", url, true);
        xmlHttp.send(null);
    }
    // Called by link in popup box
    function shn_gis_popup_delete(id)
    {
        xmlHttp = GetXmlHttpObject();
        if (xmlHttp == null){
            alert ();
            return;
        }
        ok = confirm("Are you sure you wish to Delete Feature from system");
        if(ok){
            var url = 'index.php?act=gis_popup_delete&mod=xst&stream=text&id=' + id;
            url = url +"&sid=" + Math.random();
            xmlHttp.onreadystatechange = shn_gis_popup_refresh_print;
            xmlHttp.open("GET", url, true);
            xmlHttp.send(null);
        }
    }
     // Called by dragControl after editing a Features position
    function shn_gis_popup_edit_position(feature, pixel)
    {
        xmlHttp = GetXmlHttpObject();
        if (xmlHttp==null){
            alert ("Your browser does not support AJAX!");
            return;
        }
        currentFeature = feature;
        // Move features popup to new location
        feature.popup.lonlat = feature.geometry.getBounds().getCenterLonLat();
        // Need id before clone
        var id  = feature.fid.substring(6)
        // Clone to stop any effects on the current feature.
        var cfcopy = feature.clone();
        // Transform for db.
        var lonlat = cfcopy.geometry.getBounds().getCenterLonLat().clone();
        var proj_current = map.getProjectionObject();
        lonlat.transform(proj_current, proj4326);
        var lat = lonlat.lat;
        var lon = lonlat.lon;
        var wkt = cfcopy.geometry.transform(proj_current, proj4326).toString();
        // Send to db
        var url='index.php?act=gis_popup_edit_position&mod=xst&stream=text&id=' + id;
        url = url + "&center_lat=" + lat + "&center_lon=" + lon + "&wkt=" + wkt;
        url = url +"&sid=" + Math.random();
        //xmlHttp.onreadystatechange = shn_gis_popup_print;
        xmlHttp.open("GET", url, true);
        xmlHttp.send(null);
    }
    // Called by link in popup box
    function shn_gis_popup_edit_details(id)
    {
        xmlHttp = GetXmlHttpObject();
        if (xmlHttp==null){
            alert ("Your browser does not support AJAX!");
            return;
        }
        var url='index.php?act=gis_popup_edit_details&mod=xst&stream=text&id=' + id;
        url = url +"&sid=" + Math.random();
        xmlHttp.onreadystatechange = shn_gis_popup_print;
        xmlHttp.open("GET", url, true);
        xmlHttp.send(null);
    }
    function shn_gis_popup_edit_details_ok(id)
    {
        xmlHttp = GetXmlHttpObject();
        if (xmlHttp==null){
            alert ("Your browser does not support AJAX!");
            return;
        }
        var name  = document.getElementById(id + '_popup_name').value;
        var desc  = document.getElementById(id + '_popup_desc').value;
        var auth  = document.getElementById(id + '_popup_auth').value;
        var furl   = document.getElementById(id + '_popup_url').value;
        var add   = document.getElementById(id + '_popup_add').value;
        var edate  = document.getElementById(id + '_popup_edate').value;
        var url = 'index.php?act=gis_popup_edit_details_ok&mod=xst&stream=text&id=' + id;
        url = url + "&name=" + name + "&desc=" + desc + "&auth=" + auth + "&url=" + furl + "&add=" + add + "&date=" + edate;
        url = url +"&sid=" + Math.random();
        xmlHttp.onreadystatechange = shn_gis_popup_print;
        xmlHttp.open("GET", url, true);
        xmlHttp.send(null);
    }
    function GetXmlHttpObject(){
        var xmlHttp=null;
        try{
            // Firefox, Opera 8.0+, Safari
            xmlHttp=new XMLHttpRequest();
        }
        catch (e){
            // Internet Explorer
            try{
                xmlHttp=new ActiveXObject("Msxml2.XMLHTTP");
            }
            catch (e){
                xmlHttp=new ActiveXObject("Microsoft.XMLHTTP");
            }
        }
        return xmlHttp;
    }
    </script>

<div id="center"></div>
<div id="south">
{{include 'gis/ol_status.html'}}
</div>
