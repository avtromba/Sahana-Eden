<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
{{if session.s3.debug:}}
  {{include 'sahana_styles_debug.html'}}
  {{include 'sahana_scripts_debug.html'}}
{{else:}}
  <link href="/{{=request.application}}/static/styles/S3/sahana.min.css" rel="stylesheet" type="text/css" media="screen" charset="utf-8" />
  {{include 'sahana_scripts_min.html'}}
{{pass}}
<script type="text/javascript">
$(function() {
    if (self.opener) {
        // Legacy popups
        // bind form and provide a simple callback function 
        $('form').ajaxForm(function() {
            // FIXME: Refresh just the SELECT not the whole page
            // otherwise existing inputs lost & form won't submit!
            self.opener.location.reload(true);
            // find which ID we need to make active
            {{field = '%s_%s_%s' % (module, resource, main)}}
            value=$('input#{{=field}}').val();
            $.getJSON("{{=URL(r=request, c=module, f=resource, args=['search'], vars=dict(format='json', field=main, filter='='))}}" + "&value=" + value,
                function(data) {
                    // set the caller's lookup list to the new ID
//                    self.opener.$('select#{{=caller}}').val(data[0].id);
                    // close the popup
                    self.close();
                });
        });
    } else {
    //All the relevant thickbox stuff below.
    }
});
function TB_refresh(){
    // The JSON of the thing we just created
    var $_GET = getQueryParams(document.location.search); // The Get parameters
    var listsource = document.location.pathname.replace("/create",".json");
    //This below is dropdown specific - no point calling it otherwise hence the
    //if
    if(self.parent.$('#' + $_GET["caller"] + ' >option').length ){
    //Get the previously selected value
    var selectedvalue = self.parent.$('#' + $_GET["caller"]).attr("selectedIndex");
    //Clean up the caller
    self.parent.$('#' + $_GET["caller"] + ' >option').remove();
    $.getJSON(listsource, function (data) {
        $.each(data, function() {
            self.parent.$('#' + $_GET["caller"]).append($("<option></option>").val(this['id']).html(this['name']));
        });
        //Set the previously selected value
        self.parent.$('#' + $_GET["caller"]).val(selectedvalue+1);
        self.parent.tb_remove();
    });
    }
    else{
    //nothing much to do here
        self.parent.tb_remove();
    }
}
//Function to get the URL params
function getQueryParams(qs) {
    qs = qs.split("+").join(" ");
    var params = {};
    var tokens;

    while (tokens = /[?&]?([^=]+)=([^&]*)/g.exec(qs)) {
        params[decodeURIComponent(tokens[1])]
            = decodeURIComponent(tokens[2]);
    }

    return params;
}

// If submission succesful
{{if response.flash or response.confirmation:}}
// Refresh the DIV and close the pop up
TB_refresh();
{{pass}}


</script>
</head>
<body>

{{include}}
</body>
</html>
